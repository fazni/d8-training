<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>reveal.js â€“ The HTML Presentation Framework</title>

    <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
    <meta name="author" content="Hakim El Hattab">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/solarized.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h1>Automated testing</h1>
          <p>
            <a href="https://drupal.org/u/pfrenssen">Pieter Frenssen</a> / <a href="http://twitter.com/pfrenssen">@pfrenssen</a>
          </p>
          <img src="./vrt-logo.png" style="width: auto; height: auto; border: none; box-shadow: none;">
        </section>

        <section>
          <h1>About me</h1>
          <h2>Pieter Frenssen</h2>
          <p>
            <a href="https://drupal.org/u/pfrenssen">https://drupal.org/u/pfrenssen</a><br />
            <a href="http://twitter.com/pfrenssen">http://twitter.com/pfrenssen</a>
          </p>
        </section>

        <section>
          <h2>Slides</h2>
          <p><a href="https://github.com/pfrenssen/d8-training">https://github.com/pfrenssen/d8-training</a></p>
          <p>branch: automated-testing-introduction-vrt-2h</p>
        </section>

        <section>
          <h2>A little bit of theory</h2>
        </section>

        <section>
          <h2>Goals of testing</h2>
          <ul>
            <li>Prove requirements are met</li>
            <li>Prove input is handled correctly</li>
            <li>Find bugs</li>
            <li>Prevent regressions</li>
          </ul>
        </section>

        <section>
          <h2>Different types of tests</h2>
          <ul>
            <li>Alpha / beta testing</li>
            <li>Usability testing</li>
            <li>Accessibility testing</li>
            <li>Acceptance testing</li>
            <li>Exploratory testing</li>
            <li>Security testing</li>
            <li>Unit testing</li>
            <li>Regression testing</li>
            <li>Black box testing</li>
            <li>A/B testing</li>
            <li>Compatibility testing</li>
            <li>Functional testing</li>
            <li>Performance / load / stress testing</li>
            <li>Smoke testing</li>
            <li>Fuzzing</li>
          </ul>
        </section>

        <section>
          <h2>Some definitions</h2>
          <ul>
            <li>Test runner</li>
            <li>Test case</li>
            <li>System under test</li>
            <li>Assertion</li>
            <li>Fixture</li>
            <li>Artifact</li>
          </ul>
        </section>

        <section>
          <h2>Agile workflow</h2>
          <p><img src="workflow-basic.png" /></p>
        </section>

        <section>
          <h2>Agile workflow</h2>
          <p><img src="workflow-tests.png" /></p>
        </section>

        <section>
          <h2>Agile workflow</h2>
          <p><img src="workflow-branches.png" /></p>
        </section>

        <section>
          <h2>Agile workflow</h2>
          <ul>
            <li>Create subtasks</li>
            <li>Work in separate branches</li>
            <li>QA / UAT for every subtask</li>
            <li>Only merge when tests are green</li>
          </ul>
          <p>Result: product is always shippable</p>
        </section>

        <section>
          <h3>Definition of Done</h3>
          <ul>
            <li>Implementation complete</li>
            <li>Documentation complete</li>
            <li>Tests added</li>
            <li>All tests passing</li>
            <li>Manual test instructions in ticket</li>
            <li>Track technical debt: todo's + followups</li>
          </ul>
        </section>

        <section>
          <h3>Doing effective QA</h3>
          <ul>
            <li>Start by checking the DoD</li>
            <li>Follow manual testing instructions</li>
            <li>Code review</li>
            <li>Assess if test coverage is sufficient</li>
          </ul>
        </section>

        <section>
          <h3>Continuous integration</h3>
          <ul>
            <li>Critical for success</li>
            <li>Run all tests on every push</li>
            <li>Deploy acceptance environments</li>
            <li>Travis CI / ContinuousPHP / Jenkins</li>
          </ul>
        </section>

        <section>
          <h2>History of testing in Drupal</h2>
          <h3>Simpletest</h3>
          <ul>
            <li>Adapted from simpletest/simpletest</li>
            <li>Created for Drupal 4.6 in 2004</li>
            <li>Stable release for Drupal 5.0 in 2007</li>
            <li>Adopted for Drupal 7 core in 2008</li>
          </ul>
        </section>

        <section>
          <h2>Shortcomings</h2>
          <ul>
            <li>No true unit testing</li>
            <li>Non-standard framework</li>
            <li>Can only test PHP code</li>
            <li>Slow</li>
          </ul>
        </section>

        <section>
          <h2>Drupal 8: Fix all the things</h2>
          <ul>
            <li>OOP: unit testing!</li>
            <li>Adopt industry standards</li>
            <li>Faster testing</li>
            <li>Test browser behavior</li>
            <li>Javascript testing</li>
          </ul>
        </section>

        <section>
          <h2>Simpletest in D8</h2>
          <ul>
            <li>Deprecated: will be removed in D9</li>
            <li>Custom test runner</li>
            <li>User interface</li>
            <li>Script to run tests on CLI</li>
          </ul>
        </section>

        <section>
          <h2>PHPUnit in D8</h2>
          <ul>
            <li>Modern + powerful testing framework</li>
            <li>Command line interface only</li>
          </ul>
        </section>


        <section>
          <h2>Writing tests in Drupal 8</h2>
          <ul>
            <li>UnitTestCase</li>
            <li>KernelTestBase</li>
            <li>BrowserTestBase</li>
            <li>JavaScriptTestBase</li>
            <li>Behat</li>
          </ul>
        </section>

        <section>
          <h2>Deprecated base classes</h2>
          <ul>
            <li>WebTestBase</li>
            <li>KernelTestBase</li>
          </ul>
          <p>Legacy code from Simpletest</p>
          <p>Use BrowserTestBase and the "new" KernelTestBase instead</p>
        </section>

        <section>
          <h2>Which test type to use?</h2>
        </section>

        <section>
          <h2>UnitTestCase</h2>
          <ul>
            <li>Test OOP classes in isolation</li>
            <li>Mock all dependencies</li>
            <li>Really fast</li>
            <li>Thorough testing of arguments + output</li>
            <li>Harder to write</li>
          </ul>
        </section>

        <section>
          <h2>UnitTestCase</h2>
          <h3>Useful for:</h3>
          <ul>
            <li>Services</li>
            <li>Plugins</li>
            <li>Utility classes</li>
            <li>Pure OOP code</li>
          </ul>
        </section>

        <section>
          <h2>KernelTestBase</h2>
          <ul>
            <li>Integration tests</li>
            <li>Empty database in RAM</li>
            <li>Choose database schemas to install</li>
            <li>Full Drupal API is available</li>
            <li>Runs reasonably fast</li>
            <li>Quite easy to write</li>
          </ul>
        </section>

        <section>
          <h2>KernelTestBase</h2>
          <h3>Useful for:</h3>
          <ul>
            <li>Entities</li>
            <li>Storage</li>
            <li>Config</li>
            <li>Procedural code (e.g. hooks)</li>
            <li>Interaction between modules</li>
          </ul>
        </section>

        <section>
          <h2>BrowserTestBase</h2>
          <ul>
            <li>Drupal is fully installed</li>
            <li>Choose installation profile</li>
            <li>Perform HTTP requests</li>
            <li>Verify rendered HTML</li>
            <li>Very slow to run</li>
            <li>Easy to write</li>
          </ul>
        </section>

        <section>
          <h2>BrowserTestBase</h2>
          <h3>Use it for:</h3>
          <ul>
            <li>User interaction</li>
            <li>Forms</li>
            <li>Complex integrations</li>
          </ul>
        </section>

        <section>
          <h2>JavascriptTestBase</h2>
          <ul>
            <li>Uses a real browser</li>
            <li>Mink + PhantomJS</li>
            <li>Clicking, dragging, key presses</li>
            <li>Verify DOM element visibility</li>
            <li>Execute JS code in the running browser</li>
            <li>Wait for JS events to happen</li>
          </ul>
        </section>

        <section>
          <h2>JavascriptTestBase</h2>
          <h3>Use it for:</h3>
          <ul>
            <li>Testing JS code in the live site</li>
          </ul>
        </section>

        <section>
          <h2>Behat</h2>
          <ul>
            <li>BDD</li>
            <li>Test complete user stories</li>
            <li>Plain english</li>
            <li>Domain specific language</li>
            <li>Very easy to write, great ROI</li>
            <li>Not for testing code!</li>
          </ul>
        </section>

        <section>
          <h2>Behat</h2>
          <h3>Use it for:</h3>
          <ul>
            <li>Client projects!</li>
            <li>Describing expected user behaviour</li>
            <li>Improving communication with client</li>
            <li>Proving delivery of business value</li>
          </ul>
        </section>

        <section>
          <h2>Where to put the tests</h2>
          <dl>
            <dt>UnitTestBase</dt>
            <dd>modules/my_module/tests/src/Unit/MyUnitTest.php</dd>
            <dt>KernelTestBase</dt>
            <dd>modules/my_module/tests/src/Kernel/MyKernelTest.php</dd>
            <dt>BrowserTestBase</dt>
            <dd>modules/my_module/tests/src/Functional/MyBrowserTest.php</dd>
            <dt>JavaScriptTestBase</dt>
            <dd>modules/my_module/tests/src/Functional/MyJSTest.php</dd>
          </dl>
        </section>

        <section>
          <h2>Test namespaces</h2>
          <dl>
            <dt>UnitTestBase</dt>
            <dd>\Drupal\Tests\my_module\Unit</dd>
            <dt>KernelTestBase</dt>
            <dd>\Drupal\Tests\my_module\Kernel</dd>
            <dt>BrowserTestBase</dt>
            <dd>\Drupal\Tests\my_module\Functional</dd>
            <dt>JavaScriptTestBase</dt>
            <dd>\Drupal\Tests\my_module\Functional</dd>
          </dl>
        </section>

        <section>
          <h1>Enough waffling</h1>
          <h1>Show us the code</h1>
        </section>

        <section>
          <h2>Drupal project 'starterkit'</h2>
          <a href="https://github.com/pfrenssen/drupal-project">https://github.com/pfrenssen/drupal-project.git</a>
          <p>Fork of drupal-composer/drupal-project</p>
          <p>Includes Behat, PHP CodeSniffer, CI support, ...</p>
        </section>

        <section>
          <h2>Fork it on Github</h2>
          <p><img src="fork-drupal-project.png" /></p>
        </section>

        <section>
          <h2>Enable continuous integration</h2>
          <p><img src="enable-testing-travis-ci.png" /></p>
          <p><a href="https://travis-ci.org/">https://travis-ci.org/</a></p>
          <p>Log in with your Github account</p>
        </section>

        <section>
          <h2>Clone the project locally</h2>
          <pre class="hljs"><div>
         $ git clone https://github.com/myusername/drupal-project.git
         $ cd drupal-project
         $ composer install
          </div></pre>
        </section>

        <section>
          <h3>Create a test module</h3>
          <pre><code class="hljs">
   $ cd modules
   $ mkdir one_two
   $ cd one_two
   $ mkdir -p src/Tests
   $ mkdir -p tests/src/Kernel
   $ mkdir -p tests/src/Unit
   $ mkdir -p tests/src/Functional
          </code></pre>
        </section>

        <section>
          <p>one_two.info.yml</p>
          <pre><code class="hljs">
   name: One Two, One Two
   description: Test tests
   package: Testing

   type: module
   core: 8.x
          </code></pre>
        </section>

        <section>
          <h3>WebTestBase</h3>
          <p>src/Tests/WebTest.php</p>
          <pre><code class="hljs">
  &lt;?php
  namespace Drupal\one_two\Tests;

  use Drupal\simpletest\WebTestBase;

  /**
   * Example functional test.
   *
   * @group one_two
   */
  class WebTest extends WebTestBase {
    function testDrupalGet() {
      $this->drupalGet('user/register');
      $this->assertResponse(200, 'The registration page is accessible.');
    }
  }
          </code></pre>
        </section>

        <section>
          <h2>Test output</h2>
          <p><img src="test-screenshot.png" /></p>
        </section>

        <section>
          <h3>Test some more</h3>
          <pre><code class="hljs">
  function testDrupalGet() {
    $this->drupalGet('user/register');
    $this->assertResponse(200, 'The registration page is accessible.');
    $this->assertField('mail', 'The email field is present.');
    $this->assertField('name', 'The name field is present.');
    $this->assertField('timezone', 'The timezone field is present.');
    $this->assertField('op', 'The submit button is present.');
    $this->assertNoField('zlorp', 'The zlorp field is not present.');
  }
          </code></pre>
          <p>Take a look at the available asserts.</p>
        </section>

        <section>
          <h3>Test setUp()</h3>
          <pre><code class="hljs">
class WebTest extends WebTestBase {

  protected $user;

  public static $modules = ['block', 'node', 'datetime'];

  protected function setUp() {
    parent::setUp();

    $this->drupalCreateContentType(['type' => 'page', 'name' => 'Basic page']);
    $this->user = $this->drupalCreateUser(['edit own page content', 'create page content']);
    $this->drupalPlaceBlock('local_tasks_block');
  }

}
          </code></pre>
        </section>

        <section>
          <h3>Submitting forms</h3>
          <pre><code class="hljs">
  function testNodeCreate() {
    $this->drupalLogin($this->user);

    $title = $this->randomString();
    $body = $this->randomString(32);
    $edit = [
      'title[0][value]' => $title,
      'body[0][value]' => $body,
    ];
    $this->drupalPostForm('node/add/page', $edit, t('Save'));
  }
          </code></pre>
        </section>

        <section>
          <h3>Checking saved data</h3>
          <pre><code class="hljs">
  function testNodeCreate() {
    ...

    $node = $this->drupalGetNodeByTitle($title);
    $this->assertTrue($node, 'Node found in database.');
    $this->assertIdentical($node->getTitle(), $title, 'Title is correct.');
    $this->assertIdentical($node->body->value, $title, 'Body is correct.');
  }
          </code></pre>
        </section>

        <section>
          <h3>Debugging Web Tests</h3>
          <pre><code class="hljs">
  function testNodeCreate() {
    ...

    $node = $this->drupalGetNodeByTitle($title);
    $this->assertTrue($node, 'Node found in database.');
    $this->assertIdentical($node->getTitle(), $title, 'Title is correct.');
    $this->assertIdentical($node->body->value, $title, 'Body is correct.');
    debug($node->body->value);
    debug($title);
  }
          </code></pre>
        </section>

        <section>
          <h2>Debugging output</h2>
          <p><img src="debugging.png" /></p>
        </section>

        <section>
          <h3>Debugging Tips</h3>
          <ul>
            <li>Only investigate first failure</li>
            <li>Output lots of debugging data</li>
            <li>Increase XDebug connections</li>
            <li>Inspect live database during test</li>
          </ul>
        </section>

        <section>
          <h3>Navigating</h3>
          <pre><code class="hljs">
  function testNodeCreate() {
    ...

    $this->clickLink(t('Edit'));
    $this->assertUrl($node->toUrl('edit-form', ['absolute' => TRUE]));

    $link_text = 'Edit<span class="visually-hidden">(active tab)</span>';
    $this->assertRaw($link_text, 'Edit tab found and marked active.');
  }
          </code></pre>
        </section>

        <section>
          <h3>Checking form values</h3>
          <pre><code class="hljs">
  function testNodeCreate() {
    ...

    $this->assertFieldByName('title[0][value]', $title, 'Title field displayed.');
    $this->assertFieldByName('body[0][value]', $body, 'Body field displayed.');
  }
          </code></pre>
        </section>

        <section>
          <h3>KernelTestBase</h3>
          <p>tests/src/Kernel/KernelTest.php</p>
          <pre><code class="hljs">
    &lt;?php
    namespace Drupal\Tests\one_two\Kernel;

    use Drupal\Component\Utility\Unicode;
    use Drupal\KernelTests\KernelTestBase;
    use Drupal\block_content\Entity\BlockContent;
    use Drupal\block_content\Entity\BlockContentType;

    /**
     * An example kernel test.
     *
     * @group one_two
     */
    class KernelTest extends KernelTestBase {
    }
          </code></pre>
        </section>

        <section>
          <h3>Create a block type</h3>
          <pre><code class="hljs">
    class KernelTest extends KernelTestBase {

      /**
       * Tests creation of custom blocks.
       */
      public function testBlockCreation() {
        // Create a block entity type.
        $bundle = Unicode::strtolower($this->randomMachineName());
        BlockContentType::create([
          'id' => $bundle,
          'label' => $this->randomString(),
        ])->save();
      }

    }
          </code></pre>
        </section>

        <section>
          <h3>Run PHPUnit tests from the CLI</h3>
          <pre><code class="hljs">
    $ export SIMPLETEST_BASE_URL=http://mysite.local/
    $ export SIMPLETEST_DB=mysql://user:pass@localhost/dbname

    $ cd web/
    $ ../vendor/bin/phpunit -c ./core/phpunit.xml.dist modules/one_two
          </code></pre>
          <p>See <a href="https://www.drupal.org/node/2116263">Running PHPUnit tests</a></p>
        </section>

        <section>
          <h3>Install schema</h3>
          <pre><code class="hljs">
    class KernelTest extends KernelTestBase {

      /**
       * {@inheritdoc}
       */
      public static $modules = ['system', 'block', 'block_content'];

      /**
       * {@inheritdoc}
       */
      public function setUp() {
        parent::setUp();
        $this->installEntitySchema('block_content');
      }

    }
          </code></pre>
        </section>

        <section>
          <h3>Create a block</h3>
          <pre><code class="hljs">
    class KernelTest extends KernelTestBase {

      public function testBlockCreation() {
        // ...

        // Create a block.
        $info = $this->randomMachineName();
        $block = BlockContent::create([
          'info' => $info,
          'type' => $bundle,
        ]);
        $block->save();
      }

    }
          </code></pre>
        </section>

        <section>
          <h3>Check the block</h3>
          <pre><code class="hljs">
    class KernelTest extends KernelTestBase {

      public function testBlockCreation() {
        // ...

        $this->assertEquals($info, $block->label(), 'The label was set correctly.');
        $this->assertEquals($bundle, $block->bundle(), 'The bundle was set correctly.');
      }

    }
          </code></pre>
        </section>

        <section>
          <h3>UnitTestCase</h3>
          <p>tests/src/Unit/UnitTest.php</p>
          <pre><code class="hljs">
    &lt;?php

namespace Drupal\Tests\one_two\Unit;

use Drupal\Component\Utility\UrlHelper;
use Drupal\Tests\UnitTestCase;

/**
 * @coversDefaultClass \Drupal\Component\Utility\UrlHelper
 */
class UnitTest extends UnitTestCase {
}
          </code></pre>
        </section>

        <section>
          <h3>Test isValid()</h3>
          <pre><code class="hljs">
class UnitTest extends UnitTestCase {

  /**
   * Tests valid absolute URLs.
   *
   * @dataProvider providerTestValidAbsoluteData
   * @covers ::isValid
   */
  public function testValidAbsoluteUrl($url) {
    $valid_url = UrlHelper::isValid($url, TRUE);
    $this->assertTrue($valid_url, $url . ' is a valid URL.');
  }

}
          </code></pre>
        </section>

        <section>
          <h3>Add data provider</h3>
          <pre><code class="hljs">
class UnitTest extends UnitTestCase {
  public function providerTestValidAbsoluteData() {
    return [
      ['http://example.com'],
      ['https://www.example.com'],
      ['http://ex-ample.com'],
      ['https://3xampl3.com'],
      ['http://example.com:8080'],
      ['https://subdomain.example.com'],
      ['http://example.com/index.php/node?param=false'],
      ['https://user:pass@www.example.com:8080/login.php?do=login&style=%23#pagetop'],
      ['http://127.0.0.1'],
      ['http://john%20doe:secret:foo@example.org/'],
      ['https://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:80/index.html'],
    ];
  }

}
          </code></pre>
        </section>

        <section>
          <h3>Run tests with code coverage</h3>
          <pre><code class="hljs">
    $ export SIMPLETEST_BASE_URL=http://mysite.local/
    $ export SIMPLETEST_DB=mysql://user:pass@localhost/dbname

    $ ../vendor/bin/phpunit \
      -c ./core/phpunit.xml.dist \
      --coverage-xml=result.xml \
      modules/one_two
          </code></pre>
        </section>

        <section>
          <h3>Run coverage tests in PHPStorm</h3>
          <p><a href="https://www.drupal.org/node/2288559">https://www.drupal.org/node/2288559</a></p>
          <p><img src="phpstorm-coverage.png" /></p>
        </section>

        <section>
          <h3>Mocking</h3>
          <ul>
            <li>Allows to test classes in isolation</li>
            <li>Replace dependencies with fake "mock" objects</li>
            <li>Mock objects implement an interface</li>
            <li>Full control over output</li>
            <li>Can check method calls</li>
            <li>Relies on dependency injection</li>
            <li>Prophecy</li>
          </ul>
        </section>

        <section>
          <h3>Testing user authentication</h3>
          <p>\Drupal\user\UserAuth::authenticate()</p>
          <ul>
            <li>Uses EntityManagerInterface and PasswordInterface</li>
            <li>We need to provide mocks for both</li>
          </ul>
        </section>

        <section>
          <h3>MockingTest</h3>
          <p>tests/src/Unit/MockingTest.php</p>
          <pre><code class="hljs">
    &lt;?php

namespace Drupal\Tests\one_two\Unit;

use Drupal\user\UserAuth;
use Drupal\Tests\UnitTestCase;

/**
 * @coversDefaultClass \Drupal\user\UserAuth
 */
class MockingTest extends UnitTestCase {

  protected $userStorage;
  protected $passwordService;
  protected $testUser;
  protected $userAuth;
  protected $username = 'test_user';
  protected $password = 'password';

}
          </code></pre>
        </section>

        <section>
          <h3>Test user authentication</h3>
          <pre><code class="hljs">
class MockingTest extends UnitTestCase {

  public function testAuthenticateWithCorrectPassword() {
    $this->testUser->expects($this->once())
      ->method('id')
      ->will($this->returnValue(1));

    $this->userStorage->expects($this->once())
      ->method('loadByProperties')
      ->with(array('name' => $this->username))
      ->will($this->returnValue(array($this->testUser)));

    $this->passwordService->expects($this->once())
      ->method('check')
      ->with($this->password, $this->testUser->getPassword())
      ->will($this->returnValue(TRUE));

    $this->assertSame(1, $this->userAuth->authenticate($this->username, $this->password));
  }

}
          </code></pre>
        </section>

        <section>
          <h3>The setUp()</h3>
          <pre><code class="hljs">
class MockingTest extends UnitTestCase {

  protected function setUp() {
    $this->userStorage = $this->getMock('Drupal\Core\Entity\EntityStorageInterface');

    $entity_manager = $this->getMock('Drupal\Core\Entity\EntityManagerInterface');
    $entity_manager->expects($this->any())
      ->method('getStorage')
      ->with('user')
      ->will($this->returnValue($this->userStorage));

    $this->passwordService = $this->getMock('Drupal\Core\Password\PasswordInterface');

    $this->testUser = $this->getMockBuilder('Drupal\user\Entity\User')
      ->disableOriginalConstructor()
      ->setMethods(array('id', 'setPassword', 'save', 'getPassword'))
      ->getMock();

    $this->userAuth = new UserAuth($entity_manager, $this->passwordService);
  }

}
          </code></pre>
        </section>

        <section>
          <h3>BrowserTestBase</h3>
          <p>tests/src/Functional/BrowserTest.php</p>
          <pre><code class="hljs">
    &lt;?php

    namespace Drupal\one_two\Tests;

    use Drupal\KernelTests\AssertLegacyTrait;
    use Drupal\simpletest\AssertContentTrait;
    use Drupal\simpletest\BrowserTestBase;

    class BrowserTest extends BrowserTestBase {
    }
          </code></pre>
        </section>

        <section>
          <h3>setUp()</h3>
          <p>tests/src/Functional/BrowserTest.php</p>
          <pre><code class="hljs">
class BrowserTest extends BrowserTestBase {

  use AssertContentTrait;
  use AssertLegacyTrait;

  public static $modules = ['node'];
  protected $entityTypeManager;

  public function setUp() {
    parent::setUp();

    $this->entityTypeManager = $this->container->get('entity_type.manager');

    $user = $this->drupalCreateUser(['administer content types']);
    $this->drupalLogin($user);
  }

}
          </code></pre>
        </section>

        <section>
          <h3>Create content type through UI</h3>
          <p>tests/src/Functional/BrowserTest.php</p>
          <pre><code class="hljs">
class BrowserTest extends BrowserTestBase {
  // ...

  public function testCreateContentType() {
    $edit = [
      'name' => 'My Content Type',
      'type' => 'mytype',
      'options[sticky]' => TRUE,
    ];
    $this->drupalGet('admin/structure/types/add');
    $this->submitForm($edit, t('Save content type'));
    $this->assertSession()->statusCodeEquals(200);
  }

}
          </code></pre>
        </section>

        <section>
          <h3>Assert the content type</h3>
          <p>tests/src/Functional/BrowserTest.php</p>
          <pre><code class="hljs">
  public function testCreateContentType() {
    // ...

    $this->content = $this->drupalGet('admin/structure/types/manage/mytype');
    $this->assertFieldChecked('edit-options-sticky');

    // Check if we can load the content type from the database.
    $storage = $this->entityTypeManager->getStorage('node_type');
    $entities = $storage->loadByProperties(['type' => 'mytype']);
    $this->assertEquals(1, count($entities['mytype']));
  }
          </code></pre>
        </section>

        <section>
          <h3>Debugging BrowserTestBase</h3>
          <p>tests/src/Functional/BrowserTest.php</p>
          <pre><code class="hljs">
  public function testCreateContentType() {
    $this->submitForm($edit, t('Save content type'));
    $html = $this->getSession()->getPage()->getContent();
    file_put_contents('/home/pieter/v/joinup/web/test.html', $html);

    $this->content = $this->drupalGet('admin/structure/types/manage/mytype');
    file_put_contents('/home/pieter/v/joinup/web/test2.html', $this->content);
  }
          </code></pre>
        </section>

        <section>
          <h3>Debugging BrowserTestBase</h3>
          <p>tests/src/Functional/BrowserTest.php</p>
          <pre><code class="hljs">
  public function testCreateContentType() {
    $this->submitForm($edit, t('Save content type'));
    $html = $this->getSession()->getPage()->getContent();
    file_put_contents('/home/pieter/v/joinup/web/test.html', $html);

    $this->content = $this->drupalGet('admin/structure/types/manage/mytype');
    file_put_contents('/home/pieter/v/joinup/web/test2.html', $this->content);
  }
          </code></pre>
        </section>

        <section>
          <h3>JavaScriptTestBase</h3>
          <ul>
            <li>Drupal 8.1.x</li>
            <li>PhantomJS</li>
            <li>See core/tests/README.md</li>
          </ul>
        </section>

        <section>
          <h3>Example JavaScript test</h3>
          <pre><code class="hljs">
class ToolbarIntegrationTest extends JavascriptTestBase {

  public function testToolbarToggling() {
    $this->drupalLogin($admin_user);
    $this->drupalGet('&lt;front&gt;');

    // Test that it is possible to toggle the toolbar tray.
    $this->assertElementVisible('#toolbar-link-system-admin_content', 'Toolbar tray is open by default.');
    $this->click('#toolbar-item-administration');
    $this->assertElementNotVisible('#toolbar-link-system-admin_content', 'Toolbar tray is closed after clicking the "Manage" button.');
    $this->click('#toolbar-item-administration');
    $this->assertElementVisible('#toolbar-link-system-admin_content', 'Toolbar tray is visible again after clicking the "Manage" button a second time.');
  }

}
          </code></pre>
        </section>

        <section>
          <h1>Behat</h1>
        </section>

        <section>
          <h2>What is Behat?</h2>
          <p>
            Behat is a BDD framework for PHP
          </p>
        </section>

        <section>
          <h2>What is BDD?</h2>
          <h3>Bridge between client and development team</h3>
        </section>

        <section>
          <h2>Better communication</h2>
          <ul>
            <li>A shared language</li>
            <li>Understandable by business and developers</li>
            <li>Focused on business value</li>
          </ul>
          <aside class="notes">
            Business value: answer WHY?
          </aside>
        </section>

        <section>
          <h2>Better planning</h2>
          <h3>Effective planning of development cycle</h3>
          <ul>
            <li>Based on Agile workflow</li>
            <li>Similar to user stories</li>
            <li>Provides specification (DoR)</li>
            <li>Provides acceptance criteria (DoD)</li>
          </ul>
        </section>

        <section>
          <h2>Better documentation</h2>
          <h3>Complete, always correct</h3>
          <ul>
            <li>Living documentation</li>
            <li>Every feature is documented</li>
            <li>Specification == documentation</li>
            <li>Basis for writing user manuals</li>
          </ul>
        </section>

        <section>
          <h2>Improve software quality</h2>
          <h3>Manual + automatic tests</h3>
          <ul>
            <li>Developer ensures specification is met</li>
            <li>QA engineer can validate</li>
            <li>Product owner can approve</li>
          </ul>
        </section>

        <section>
          <h1>Gherkin</h1>
        </section>

        <section>
          <h2>Gherkin</h2>
          <h3>A language understandable by everyone</h3>
          <ul>
            <li>Business readable</li>
            <li>Developer readable</li>
            <li>Machine readable</li>
            <li>Domain specific</li>
          </ul>
        </section>

        <section>
          <h2>Gherkin example</h2>
          <pre><code class="hljs">
              Feature: Product highlights
                In order to promote specific products
                As a marketing manager
                I need to highlight products on the homepage

              Scenario: View product highlights
                Given I have 3 product highlights
                When I visit the frontpage
                Then I should see 3 highlighted products
          </code></pre>
        </section>

        <section>
          <h2>Gherkin structure</h2>
          <pre><code class="hljs">
              Feature: &lt; title &gt;
                In order to &lt; business objective &gt;
                As a &lt; user role or persona &gt;
                I need to &lt; some action &gt;

              Scenario:
                Given &lt; a precondition &gt;
                When &lt; some action &gt;
                And &lt; some other action &gt;
                Then &lt; a testable outcome &gt;
                But &lt; something else we can test &gt;
          </code></pre>
        </section>

        <section>
          <h2>Scenario outlines</h2>
          <pre><code class="hljs">
              Scenario: Show number of likes
                Given I am logged in as &lt;user&gt;
                When I visit the profile of &lt;friend&gt;
                And I click on "Like"
                Then I should see &lt;number&gt; likes

                Examples:
                | user   | friend | number |
                | Cindy  | Cindy  | 0      |
                | Thomas | Cindy  | 1      |
                | Thomas | Cindy  | 1      |
                | Roger  | Cindy  | 2      |
                | Roger  | Thomas | 1      |
          </code></pre>
        </section>

        <section>
          <h2>Tables</h2>
          <pre><code class="hljs">
              Scenario:
                Given the following users exist:
                | username | email                 |
                | Cindy    | hypodrake@hotmail.com |
                | Thomas   | thofpop@ec.europa.eu  |
                | Roger    | sirfrodo@gmail.com    |
          </code></pre>
        </section>

        <section>
          <h3>Behat configuration</h3>
          <p>tests/behat.yml</p>
          <pre><div class="hljs">
default:
  suites:
    default:
      contexts:
        - FeatureContext
        - Drupal\DrupalExtension\Context\DrupalContext
        - Drupal\DrupalExtension\Context\DrushContext
        - Drupal\DrupalExtension\Context\MessageContext
        - Drupal\DrupalExtension\Context\MinkContext
      filters:
        tags: "~@wip"
  extensions:
    Behat\MinkExtension:
      base-url: 'http://drupal-project.local'
      files_path: '/home/pieter/drupal-project/tests/fixtures/files'
      goutte: ~
      javascript_session: 'selenium2'
      selenium2: ~
    Drupal\DrupalExtension:
      api_driver: 'drupal'
      blackbox: ~
      drupal:
        drupal_root: '/home/pieter/drupal-project/web'
      selectors:
        message_selector: '.messages'
        error_message_selector: '.messages.messages--error'
        success_message_selector: '.messages.messages--status'
      subcontexts:
        paths:
          - '/home/pieter/drupal-project/web/modules'
  formatters:
    progress: ~
          </div></pre>
        </section>

        <section>
          <h2>Example test I</h2>
          <pre><div class="hljs">
Scenario: Anonymous user can see the user login page
  Given I am not logged in
  When I visit "user"
  Then I should see the text "Log in"
  And I should see the text "Reset your password"
  And I should see the text "Username"
  And I should see the text "Password"
  But I should not see the text "Log out"
  And I should not see the text "My account"
          </div></pre>
        </section>

        <section>
          <h2>Example test II</h2>
          <pre><div class="hljs">
Scenario Outline: Anonymous user cannot access site administration
  Given I am not logged in
  When I go to "<path>"
  Then I should get an access denied error

  Examples:
  | path            |
  | admin           |
  | admin/config    |
  | admin/content   |
  | admin/people    |
  | admin/structure |
  | node/add        |
  | node/add/page   |
          </div></pre>
        </section>

        <section>
          <h2>Run example tests</h2>
          <pre><div class="hljs">
              $ cd tests/
              $ ./behat
          </div></pre>
        </section>

        <section>
          <h2>Built-in step definitions</h2>
          <pre><div class="hljs">
            $ ./behat -di

            <span class="fragment">Given I am not logged in
            Given I am logged in as :name</span>

            <span class="fragment">Given a/an :type (content )with the title :title</span>

            <span class="fragment">When I visit :path
            When I click :link
            When I enter :value for :field
            When I press the :button button</span>

            <span class="fragment">Then I should see the text :text
            Then I should not see the link :link</span>
          </div></pre>
          <p class="fragment">More than 100 built-in steps!</p>
        </section>

        <section>
          <h2>Bad built-in stuff</h2>
          <pre><div class="hljs">
          Then I should get a :code HTTP response
          Then I should see text matching "&lt;regex&gt;"
          Then I should see :number "&lt;element&gt;" elements
          Given the cache has been cleared
          Given I run cron
          Given I run drush :command
          Given I wait for AJAX to finish
          </div></pre>
          <h3>No business would ever use this language!</h3>
        </section>

        <section>
          <h2>Use domain specific language</h2>
          <pre><div class="hljs">
          Then I should see the text "Page not found"
          Then I should see the welcome message
          Then I should see 5 blog posts
          And I wait for the autocomplete suggestions to appear
          </div></pre>
        </section>

        <section>
          <h3>features/newsroom.feature</h3>
          <pre><div class="hljs">
           @api
           Scenario: Anonymous user can see the news overview
             Given "News article" content:
             | title     | body                |
             | Article 1 | The first article.  |
             | Article 2 | The second article. |

             Given I am not logged in
             When I visit "news"
             Then I should see the heading "News"
             And I should see the link "Article 1"
             And I should see the text "The first article."
             And I should see the link "Article 2"
             And I should see the text "The second article."
          </div></pre>
        </section>

        <section>
          <h2>Run the test</h2>
          <pre><div class="hljs">
          $ ./behat

          <span class="fragment">
         @api
         Scenario: Anonymous user can see the news overview
           Given "News article" content:
             | title     | body                |
             | Article 1 | The first article.  |
             | Article 2 | The second article. |
           Given I am not logged in
           ...

         1 scenario (1 passed)
         8 steps (8 passed)
         0m0.75s (34.45Mb)
           </span>
          </div></pre>
          <aside class="notes">
            For the tests to pass you might need to implement the functionality :)
          </aside>
        </section>

        <section>
          <h2>Defining your own steps</h2>
          <pre><div class="hljs">
          @api
          Scenario: Anonymous user can see the news overview
            Given "News article" content:
            | title     | body                |
            | Article 1 | The first article.  |
            | Article 2 | The second article. |
            | Article 3 | The third article.  |

            Given I am not logged in
            When I visit "news"
            Then I should see the heading "News"
            And I should see 3 news articles     &lt;&lt;&lt;&lt;&lt; CUSTOM STEP
          </div></pre>
        </section>

        <section>
          <h2>Defining your own steps</h2>
          <pre><div class="hljs">
  $ ./behat

  1 scenario (1 undefined)
  5 steps (4 passed, 1 undefined)
  0m5.47s (42.90Mb)

  --- FeatureContext has missing steps. Define them with these snippets:

      /**
       * @Then I should see :arg1 news articles
       */
      public function iShouldSeeNewsArticles($arg1)
      {
          throw new PendingException();
      }
          </div></pre>
        </section>

        <section>
          <h2>Add missing steps automatically</h2>
          <pre><div class="hljs">
          $ ./behat --append-snippets

          1 scenario (1 undefined)
          5 steps (4 passed, 1 undefined)
          0m5.47s (42.90Mb)

          `I should see 3 news articles` definition added
          </div></pre>
        </section>

        <section>
          <h2>Implementation</h2>
          <pre><div class="hljs">
    /**
     * @Then I should see :number news articles
     */
    public function assertNewsArticleCount($number) {
      $this->assertSession()->elementsCount('css', 'div.news-article', $number);
    }
          </div></pre>
          <p>See MinkContext and DrupalContext</p>
        </section>

        <section>
          <h2>Selenium</h2>
          <ul><li>Supported by Mink</li>
          <li>Install selenium-server-standalone</li>
          <li>Use tag `@javascript`</li></ul>
        </section>

        <section>
          <h2>Questions?</h2>
        </section>

      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,
        width: 1280,
        height: 800,

        transition: 'convex', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
